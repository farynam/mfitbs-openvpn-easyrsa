- name: Create certificate for a client
  shell: easyrsa build-client-full {{ ansible_host }} nopass
  args:
    chdir: /root
    creates: "{{ PKI_DIR }}/issued/{{ ansible_host }}.crt"
  environment:
    PATH: "{{ EASY_RSA_BIN }}/{{ EASY_RSA_ARCH_DIR }}:{{ ansible_env.PATH }}"
  delegate_to: "{{ easy_rsa_host }}"

- name: Grab client cert locally
  fetch:
    src: "{{PKI_DIR}}/issued/{{ ansible_host }}.crt"
    dest: "{{ LOCAL_REPO }}/clients/issued/"
    flat: yes
  delegate_to: "{{ easy_rsa_host }}"

- name: Grab keys locally
  fetch:
    src: "{{PKI_DIR}}/private/{{ ansible_host }}.key"
    dest: "{{ LOCAL_REPO }}/clients/private/"
    flat: yes
  delegate_to: "{{ easy_rsa_host }}"
